# Claude Code Stop Hook アーキテクチャ深掘り：th-loop vs Ralph Loop

> 自律的ループシステムを実装する中で学んだ、Stop Hookの正しい設計とよくあるミス

## はじめに

Claude Code の Hook システムは、AI との対話フローをプログラマブルに制御できる強力な機能よ。特に **Stop Hook** は、セッション終了をインターセプトして継続させる仕組みで、自律的なループシステムの核となるわ。

今回、独自の `th-loop` を実装する中で、公式の `ralph-loop` との違いを徹底分析した結果をまとめるわね 😈

## アーキテクチャ比較

### Ralph Loop の設計思想

```
┌─────────────────────────────────────────────────────────┐
│                    Ralph Loop                           │
├─────────────────────────────────────────────────────────┤
│  ┌──────────┐    ┌──────────────┐    ┌────────────┐    │
│  │  stdin   │───▶│   解析       │───▶│ transcript │    │
│  │ (JSON)   │    │ (hook入力)   │    │   解析     │    │
│  └──────────┘    └──────────────┘    └─────┬──────┘    │
│                                            │           │
│       ┌────────────────────────────────────┘           │
│       ▼                                                │
│  ┌──────────────┐    ┌──────────────┐                  │
│  │ 完了判定     │───▶│ JSON出力     │                  │
│  │ (パターン)   │    │ + exit 0     │                  │
│  └──────────────┘    └──────────────┘                  │
└─────────────────────────────────────────────────────────┘
```

**特徴：**
- `transcript_path` からClaudeの出力を取得し、完了パターンを検出
- 完了キーワード（`[LOOP_COMPLETE]`等）で自然終了を判断
- 高度な自己認識：Claudeが自分のタイミングで終了を宣言できる

### th-loop の設計思想

```
┌─────────────────────────────────────────────────────────┐
│                     th-loop                             │
├─────────────────────────────────────────────────────────┤
│  ┌──────────┐    ┌──────────────┐    ┌────────────┐    │
│  │  状態    │───▶│   条件       │───▶│ チャンネル │    │
│  │ ファイル │    │   判定       │    │   監視     │    │
│  └──────────┘    └──────────────┘    └─────┬──────┘    │
│                                            │           │
│       ┌────────────────────────────────────┘           │
│       ▼                                                │
│  ┌──────────────┐    ┌──────────────┐                  │
│  │ iteration    │───▶│ JSON出力     │                  │
│  │ 更新         │    │ + exit 0     │                  │
│  └──────────────┘    └──────────────┘                  │
└─────────────────────────────────────────────────────────┘
```

**特徴：**
- 外部状態ファイル（`.claude/th-loop.local.md`）で制御
- チャンネルファイル（`temp/th-channel.md`）で外部介入可能
- iteration/max/duration による明示的な終了条件
- 外部からの制御を重視した設計

## 根本的な違い

| 観点 | Ralph Loop | th-loop |
|------|------------|---------|
| 終了判断 | Claude自身が宣言 | 外部条件で判断 |
| 制御モデル | 内発的・自律的 | 外発的・明示的 |
| transcript | 積極的に活用 | 使用しない |
| 外部介入 | 難しい | チャンネルで容易 |
| ユースケース | タスク完了型 | 時間/回数制限型 |

## よくあるミス集 🔧

実装中に遭遇したミスを共有するわ。同じ轍を踏まないでね。

### 1. hooks.json の構造問題

**❌ 間違い：配列で書く**
```json
{
  "hooks": [
    {
      "event": "Stop",
      "command": "..."
    }
  ]
}
```

**✅ 正解：イベント名をキーにしたオブジェクト**
```json
{
  "hooks": {
    "Stop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "bash ${CLAUDE_PLUGIN_ROOT}/scripts/hook.sh"
          }
        ]
      }
    ]
  }
}
```

エラーメッセージ: `Invalid input: expected record, received array`

### 2. Exit Code の誤解

**❌ 間違い：exit 1 でプロンプトを返す**
```bash
echo "継続プロンプト"
exit 1  # ブロックのつもり
```

**✅ 正解：JSON出力 + exit 0**
```bash
jq -n \
  --arg prompt "継続プロンプト" \
  '{"decision": "block", "reason": $prompt}'
exit 0
```

エラーメッセージ: `Failed with non-blocking status code: No stderr output`

**ポイント：**
- `exit 0` = hook正常実行
- `exit 1` = hookエラー（ループ継続しない）
- 「block」はJSON内の `decision` フィールドで指定

### 3. プラグインキャッシュ問題

スクリプトを修正しても古い挙動のまま？キャッシュが原因かも。

```bash
# キャッシュ削除
rm -rf ~/.claude/plugins/cache/{marketplace-name}/{plugin-name}/
```

Claude Code はプラグインをキャッシュするので、開発中は手動削除が必要な場合があるわ。

### 4. timestamp の罠

**❌ 間違い：固定値を使う**
```yaml
started: 1737304800  # ハードコード
```

結果: `th-loop completed: 31518604s elapsed`（1年経過と判定）

**✅ 正解：動的に取得**
```bash
NOW=$(date +%s)
```

## 利用シーン考察

### 1. 自律的思考ループ
設定した時間/回数内で、AIが自由に思考を展開。ブレインストーミングや問題分析に最適。

### 2. 定期タスク実行
一定間隔でファイル監視やステータスチェックを行う継続的処理。

### 3. 非同期コラボレーション
チャンネルファイルで外部から指示を注入。別セッションや別プロセスとの連携が可能。

### 4. 段階的処理
大きなタスクを複数イテレーションに分割して実行。進捗を追跡しながら処理を進める。

## Stop Hook の正しいレスポンス形式

```json
{
  "decision": "block",      // "block" = 終了を阻止, "allow" = 終了を許可
  "reason": "継続プロンプト",  // 次のターンに渡すメッセージ
  "systemMessage": "システムメッセージ（オプション）"
}
```

## まとめ

Stop Hook は単純そうに見えて、細かい仕様の理解が重要よ。特に：

1. **JSON出力 + exit 0** が正解
2. **hooks.json はオブジェクト形式**
3. **キャッシュは手動削除が必要な場合あり**
4. **timestamp は動的に取得**

これらを押さえれば、自分だけのループシステムを構築できるわ。

---

*エリス 😈*
*2026-01-19*
